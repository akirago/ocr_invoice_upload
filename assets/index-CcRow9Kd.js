(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function e(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(a){if(a.ep)return;a.ep=!0;const r=e(a);fetch(a.href,r)}})();async function E(n){const t={video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1440}},audio:!1};try{const e=await navigator.mediaDevices.getUserMedia(t);return n.srcObject=e,await new Promise(o=>{n.onloadedmetadata=()=>{n.play(),o()}}),e}catch(e){if(e.name==="OverconstrainedError"){const o=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});return n.srcObject=o,await new Promise(a=>{n.onloadedmetadata=()=>{n.play(),a()}}),o}throw e}}async function F(n,t){const e=t.getContext("2d");return t.width=n.videoWidth,t.height=n.videoHeight,e.drawImage(n,0,0),new Promise((o,a)=>{t.toBlob(r=>{r?o(r):a(new Error("Failed to create image blob"))},"image/jpeg",.85)})}const P="modulepreload",j=function(n){return"/ocr_invoice_upload/"+n},S={},O=function(t,e,o){let a=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),s=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));a=Promise.allSettled(e.map(l=>{if(l=j(l),l in S)return;S[l]=!0;const u=l.endsWith(".css"),p=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${p}`))return;const d=document.createElement("link");if(d.rel=u?"stylesheet":P,u||(d.as="script"),d.crossOrigin="",d.href=l,s&&d.setAttribute("nonce",s),document.head.appendChild(d),u)return new Promise((m,w)=>{d.addEventListener("load",m),d.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${l}`)))})}))}function r(i){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=i,window.dispatchEvent(s),!s.defaultPrevented)throw i}return a.then(i=>{for(const s of i||[])s.status==="rejected"&&r(s.reason);return t().catch(r)})};let g=null;async function N(){if(g)return g;const{createWorker:n}=await O(async()=>{const{createWorker:t}=await import("./index-BZH6TDpT.js").then(e=>e.i);return{createWorker:t}},[]);return g=await n("jpn",1,{logger:t=>{t.status==="recognizing text"&&t.progress&&window.ocrProgressCallback&&window.ocrProgressCallback(t.progress)}}),g}async function I(n,t){window.ocrProgressCallback=t;try{t(0);const e=await N(),o=await _(n),{data:{text:a}}=await e.recognize(o);return t(1),a}catch(e){throw console.error("OCR error:",e),new Error("OCR処理に失敗しました")}finally{delete window.ocrProgressCallback}}function $(n){const t=[],e=[],o=n.split(`
`);for(const s of o){const l=s.trim();if(!l)continue;const u=U(l);u!==0&&(l.includes("円")||l.includes("¥")?t.includes(u)||t.push(u):e.includes(u)||e.push(u))}t.sort((s,l)=>l-s),e.sort((s,l)=>l-s);const a=[];let r=0,i=0;for(;a.length<9&&(r<t.length||i<e.length);)r<t.length&&a.push(t[r++]),a.length<9&&i<e.length&&a.push(e[i++]);return a}function C(n){const t=[],e=[/\b(20\d{2})\/(0?[1-9]|1[0-2])\/(0?[1-9]|[12][0-9]|3[01])\b/g,/\b(20\d{2})-(0?[1-9]|1[0-2])-(0?[1-9]|[12][0-9]|3[01])\b/g,/\b(20\d{2})\.(0?[1-9]|1[0-2])\.(0?[1-9]|[12][0-9]|3[01])\b/g,/\b(20\d{2})年(0?[1-9]|1[0-2])月(0?[1-9]|[12][0-9]|3[01])日\b/g,/\b(0?[1-9]|1[0-2])\/(0?[1-9]|[12][0-9]|3[01])\/(20\d{2})\b/g];for(const o of e){let a;for(;(a=o.exec(n))!==null;){let r,i,s;if(o.source.includes("(0?[1-9]|1[0-2])")&&(a[3]&&a[3].length===4?(i=a[1],s=a[2],r=a[3]):(r=a[1],i=a[2],s=a[3])),r=parseInt(r,10),i=parseInt(i,10),s=parseInt(s,10),r>=2020&&r<=2030&&i>=1&&i<=12&&s>=1&&s<=31){const l=`${r}-${String(i).padStart(2,"0")}-${String(s).padStart(2,"0")}`;t.includes(l)||t.push(l)}}}return t}function U(n){let t=n.replace(/(\d)j(\d{3})/g,"$1,$2").replace(/(\d)J(\d{3})/g,"$1,$2");if(t.match(/^\s*¥(\d{1,2})\s*$/))return 0;let o="",a=t.includes("¥")||t.includes("円");for(const i of t){if(/\d/.test(i))o+=i;else if(i===","||i===".")continue;if(o.length>5)return 0}if(!o)return 0;o.length===4&&!a&&n.match(/^\s*1\d{3}\s*$/)&&n.match(/[¥円]/);const r=parseInt(o,10);return r>=100&&r<=3e4?r:0}function _(n){return new Promise((t,e)=>{const o=new FileReader;o.onloadend=()=>t(o.result),o.onerror=e,o.readAsDataURL(n)})}window.addEventListener("beforeunload",async()=>{g&&await g.terminate()});async function R(n,t){if(navigator.share&&navigator.canShare){const e={files:[n],title:t,text:"Save to Google Drive"};try{if(navigator.canShare(e))return await navigator.share(e),!0}catch(o){console.log("Share cancelled or failed:",o)}}return q(n,t),!1}function q(n,t){const e=URL.createObjectURL(n),o=document.createElement("a");o.href=e,o.download=t,o.style.display="none",document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(e)},100)}function f(n=null,t=null,e=null){let o;if(e)o=e;else{const r=new Date,i=r.getFullYear(),s=String(r.getMonth()+1).padStart(2,"0"),l=String(r.getDate()).padStart(2,"0");o=`${i}-${s}-${l}`}let a=o;return n&&(a+=`_${n}`),t&&(a+=`_${t}`),`${a}.jpg`}const k="drive-ocr-expense-items",M=[{id:"kaigi",label:"会議"},{id:"kousai",label:"交際"},{id:"koutuuhi",label:"交通費"},{id:"iryou",label:"医療"}];function x(){try{const n=localStorage.getItem(k);if(n)return JSON.parse(n)}catch(n){console.error("Failed to load expense items:",n)}return[...M]}function A(n){try{localStorage.setItem(k,JSON.stringify(n))}catch(t){console.error("Failed to save expense items:",t)}}function W(n,t){const e=x();return e.some(o=>o.id===t)?!1:(e.push({id:t,label:n}),A(e),!0)}function B(n,t){const e=document.createElement("div");e.className="dialog-backdrop",e.innerHTML=`
    <div class="dialog">
      <h3 class="dialog-title">金額を選択してください</h3>
      <div class="dialog-options">
        ${n.map((i,s)=>`
          <button class="dialog-option" data-value="${i}">
            ¥${i.toLocaleString()}
          </button>
        `).join("")}
        <button class="dialog-option dialog-manual" data-value="manual">
          ✍️ 手動入力
        </button>
        <input type="number" class="dialog-amount-input" id="manual-amount-input" 
               placeholder="金額を入力" min="100" max="30000" 
               style="display: none;">
        <button class="dialog-option" data-value="none">
          上記以外
        </button>
        <button class="dialog-option dialog-retry" data-value="retry">
          📷 撮り直す
        </button>
      </div>
    </div>
  `;const o=e.querySelector("#manual-amount-input"),a=e.querySelector(".dialog-manual"),r=i=>{if(i.target.classList.contains("dialog-option")){const s=i.target.dataset.value;s==="manual"?(o.style.display="block",a.style.display="none",o.focus()):s==="retry"?(e.remove(),t("retry")):(e.remove(),t(s==="none"?null:s))}};o.addEventListener("keypress",i=>{if(i.key==="Enter"){const s=parseInt(o.value,10);s>=100&&s<=3e4?(e.remove(),t(String(s))):(o.style.borderColor="#f44336",setTimeout(()=>{o.style.borderColor="#4285f4"},1e3))}}),o.addEventListener("blur",i=>{setTimeout(()=>{e.contains(o)&&!o.value&&(o.style.display="none",a.style.display="block")},200)}),e.addEventListener("click",r),document.body.appendChild(e)}function L(n){const t=x(),e=document.createElement("div");e.className="dialog-backdrop",e.innerHTML=`
    <div class="dialog">
      <h3 class="dialog-title">項目を選択してください</h3>
      <div class="dialog-options">
        ${t.map(p=>`
          <button class="dialog-option" data-value="${p.id}">
            ${p.label}
          </button>
        `).join("")}
        <button class="dialog-option dialog-add" data-value="add">
          ➕ 項目を追加
        </button>
        <div class="dialog-add-form" style="display: none;">
          <input type="text" class="dialog-item-input" id="new-item-label" 
                 placeholder="項目名（日本語）" >
          <input type="text" class="dialog-item-input" id="new-item-id" 
                 placeholder="ファイル名用（ローマ字）" 
                 pattern="[a-zA-Z0-9_]+">
      </div>
    </div>
  `;const o=e.querySelector(".dialog-add-form"),a=e.querySelector("#new-item-label"),r=e.querySelector("#new-item-id"),i=e.querySelector(".dialog-add"),s=p=>{if(p.target.classList.contains("dialog-option")){const d=p.target.dataset.value;d==="add"?(o.style.display="block",i.style.display="none",a.focus()):(e.remove(),n(d))}},l=()=>{const p=a.value.trim(),d=r.value.trim();if(p&&d){if(!/^[a-zA-Z0-9_]+$/.test(d)){r.style.borderColor="#f44336",setTimeout(()=>{r.style.borderColor="#4285f4"},1e3);return}W(p,d)?(e.remove(),L(n)):(r.style.borderColor="#f44336",setTimeout(()=>{r.style.borderColor="#4285f4"},1e3))}};a.addEventListener("keypress",p=>{p.key==="Enter"&&r.focus()}),r.addEventListener("keypress",p=>{p.key==="Enter"&&l()});const u=()=>{setTimeout(()=>{e.contains(o)&&!a.value&&!r.value&&(o.style.display="none",i.style.display="block",a.value="",r.value="")},200)};a.addEventListener("blur",u),r.addEventListener("blur",u),e.addEventListener("click",s),document.body.appendChild(e)}function y(n,t){const e=new Date,o=new Date(e);o.setDate(o.getDate()-1);const a=d=>{const m=d.getFullYear(),w=String(d.getMonth()+1).padStart(2,"0"),D=String(d.getDate()).padStart(2,"0");return`${m}-${w}-${D}`},r=a(e),i=a(o),s=document.createElement("div");s.className="dialog-backdrop",s.innerHTML=`
    <div class="dialog">
      <h3 class="dialog-title">日付を選択してください</h3>
      <div class="dialog-options">
        <button class="dialog-option" data-value="${r}">
          今日 (${r})
        </button>
        <button class="dialog-option" data-value="${i}">
          昨日 (${i})
        </button>
        ${n.map(d=>`
          <button class="dialog-option" data-value="${d}">
            画像から読み取った日付 (${d})
          </button>
        `).join("")}
        <button class="dialog-option dialog-manual" data-value="manual">
          📅 手動で選ぶ
        </button>
        <input type="date" class="dialog-date-input" id="manual-date-input" value="${r}" style="display: none;">
        <button class="dialog-option" data-value="none">
          選択しない
        </button>
      </div>
    </div>
  `;const l=s.querySelector("#manual-date-input"),u=s.querySelector(".dialog-manual"),p=d=>{if(d.target.classList.contains("dialog-option")){const m=d.target.dataset.value;m==="manual"?(l.style.display="block",u.style.display="none",l.focus(),l.showPicker()):(s.remove(),t(m==="none"?null:m))}};l.addEventListener("change",d=>{const m=d.target.value;m&&(s.remove(),t(m))}),l.addEventListener("blur",d=>{setTimeout(()=>{s.contains(l)&&(l.style.display="none",u.style.display="block")},200)}),s.addEventListener("click",p),document.body.appendChild(s)}const c={video:document.getElementById("camera-video"),placeholder:document.getElementById("camera-placeholder"),captureBtn:document.getElementById("capture-btn"),uploadBtn:document.getElementById("upload-btn"),fileInput:document.getElementById("file-input"),progressContainer:document.getElementById("progress-container"),progressFill:document.getElementById("progress-fill"),progressText:document.getElementById("progress-text"),output:document.getElementById("output"),outputText:document.getElementById("output-text"),error:document.getElementById("error"),canvas:document.getElementById("capture-canvas")};let b=null;async function Y(){try{b=await E(c.video),c.placeholder.style.display="none",c.captureBtn.disabled=!1}catch(n){v("カメラへのアクセスが拒否されました。設定を確認してください。"),console.error("Camera init error:",n)}c.captureBtn.addEventListener("click",z),c.uploadBtn.addEventListener("click",()=>c.fileInput.click()),c.fileInput.addEventListener("change",H),document.addEventListener("visibilitychange",async()=>{if(document.visibilityState==="visible"&&b){const n=b.getVideoTracks();if(n.length===0||n[0].readyState!=="live")try{b=await E(c.video)}catch(t){console.error("Camera recovery failed:",t)}}})}async function z(){try{T(),c.captureBtn.disabled=!0;const n=await F(c.video,c.canvas);c.progressContainer.classList.add("active"),c.output.classList.remove("active");const t=await I(n,a=>{const r=Math.round(a*100);c.progressFill.style.width=`${r}%`,c.progressText.textContent=`${r}%`});if(c.progressContainer.classList.remove("active"),!t||t.trim().length===0){v("テキストを認識できませんでした。");return}c.output.classList.add("active"),c.outputText.textContent=t;const e=$(t),o=C(t);e.length===0?y(o,async a=>{const r=f(null,null,a),i=new File([n],r,{type:"image/jpeg"});await h(i)}):B(e,async a=>{if(a==="retry"){c.output.classList.remove("active");return}else a===null?y(o,async r=>{const i=f(null,null,r),s=new File([n],i,{type:"image/jpeg"});await h(s)}):y(o,async r=>{L(async i=>{const s=f(a,i,r),l=new File([n],s,{type:"image/jpeg"});await h(l)})})})}catch(n){v("処理中にエラーが発生しました: "+n.message),console.error("Capture error:",n)}finally{c.captureBtn.disabled=!1}}async function H(n){const t=n.target.files[0];if(t)try{T();const e=t;c.progressContainer.classList.add("active"),c.output.classList.remove("active");const o=await I(e,i=>{const s=Math.round(i*100);c.progressFill.style.width=`${s}%`,c.progressText.textContent=`${s}%`});if(c.progressContainer.classList.remove("active"),!o||o.trim().length===0){v("テキストを認識できませんでした。");return}c.output.classList.add("active"),c.outputText.textContent=o;const a=$(o),r=C(o);a.length===0?y(r,async i=>{const s=f(null,null,i),l=new File([e],s,{type:"image/jpeg"});await h(l)}):B(a,async i=>{if(i==="retry"){c.output.classList.remove("active"),c.fileInput.value="";return}else i===null?y(r,async s=>{const l=f(null,null,s),u=new File([e],l,{type:"image/jpeg"});await h(u)}):y(r,async s=>{L(async l=>{const u=f(i,l,s),p=new File([e],u,{type:"image/jpeg"});await h(p)})})})}catch(e){v("処理中にエラーが発生しました: "+e.message),console.error("Upload error:",e)}finally{c.fileInput.value=""}}async function h(n){await R(n,n.name)||v("共有に失敗しました。手動でダウンロードしてください。")}function v(n){c.error.textContent=n,c.error.classList.add("active")}function T(){c.error.classList.remove("active")}Y();
