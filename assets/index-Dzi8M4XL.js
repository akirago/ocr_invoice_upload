(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))e(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();async function S(o){const n={video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1440}},audio:!1};try{const t=await navigator.mediaDevices.getUserMedia(n);return o.srcObject=t,await new Promise(e=>{o.onloadedmetadata=()=>{o.play(),e()}}),t}catch(t){if(t.name==="OverconstrainedError"){const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});return o.srcObject=e,await new Promise(r=>{o.onloadedmetadata=()=>{o.play(),r()}}),e}throw t}}async function P(o,n){const t=n.getContext("2d");return n.width=o.videoWidth,n.height=o.videoHeight,t.drawImage(o,0,0),new Promise((e,r)=>{n.toBlob(s=>{s?e(s):r(new Error("Failed to create image blob"))},"image/jpeg",.85)})}const F="modulepreload",j=function(o){return"/ocr_invoice_upload/"+o},E={},O=function(n,t,e){let r=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),i=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));r=Promise.allSettled(t.map(l=>{if(l=j(l),l in E)return;E[l]=!0;const u=l.endsWith(".css"),v=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${v}`))return;const d=document.createElement("link");if(d.rel=u?"stylesheet":F,u||(d.as="script"),d.crossOrigin="",d.href=l,i&&d.setAttribute("nonce",i),document.head.appendChild(d),u)return new Promise((p,w)=>{d.addEventListener("load",p),d.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(a){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=a,window.dispatchEvent(i),!i.defaultPrevented)throw a}return r.then(a=>{for(const i of a||[])i.status==="rejected"&&s(i.reason);return n().catch(s)})};let m=null;async function N(){if(m)return m;const{createWorker:o}=await O(async()=>{const{createWorker:n}=await import("./index-BZH6TDpT.js").then(t=>t.i);return{createWorker:n}},[]);return m=await o("jpn",1,{logger:n=>{n.status==="recognizing text"&&n.progress&&window.ocrProgressCallback&&window.ocrProgressCallback(n.progress)}}),m}async function I(o,n){window.ocrProgressCallback=n;try{n(0);const t=await N(),e=await _(o),{data:{text:r}}=await t.recognize(e);return n(1),r}catch(t){throw console.error("OCR error:",t),new Error("OCR処理に失敗しました")}finally{delete window.ocrProgressCallback}}function $(o){const n=[],t=[],e=o.split(`
`);for(const i of e){const l=i.trim();if(!l)continue;const u=U(l);u!==0&&(l.includes("円")||l.includes("¥")?n.includes(u)||n.push(u):t.includes(u)||t.push(u))}n.sort((i,l)=>l-i),t.sort((i,l)=>l-i);const r=[];let s=0,a=0;for(;r.length<9&&(s<n.length||a<t.length);)s<n.length&&r.push(n[s++]),r.length<9&&a<t.length&&r.push(t[a++]);return r}function C(o){const n=[],t=[/\b(20\d{2})\/(0?[1-9]|1[0-2])\/(0?[1-9]|[12][0-9]|3[01])\b/g,/\b(20\d{2})-(0?[1-9]|1[0-2])-(0?[1-9]|[12][0-9]|3[01])\b/g,/\b(20\d{2})\.(0?[1-9]|1[0-2])\.(0?[1-9]|[12][0-9]|3[01])\b/g,/\b(20\d{2})年(0?[1-9]|1[0-2])月(0?[1-9]|[12][0-9]|3[01])日\b/g,/\b(0?[1-9]|1[0-2])\/(0?[1-9]|[12][0-9]|3[01])\/(20\d{2})\b/g];for(const e of t){let r;for(;(r=e.exec(o))!==null;){let s,a,i;if(e.source.includes("(0?[1-9]|1[0-2])")&&(r[3]&&r[3].length===4?(a=r[1],i=r[2],s=r[3]):(s=r[1],a=r[2],i=r[3])),s=parseInt(s,10),a=parseInt(a,10),i=parseInt(i,10),s>=2020&&s<=2030&&a>=1&&a<=12&&i>=1&&i<=31){const l=`${s}-${String(a).padStart(2,"0")}-${String(i).padStart(2,"0")}`;n.includes(l)||n.push(l)}}}return n}function U(o){let n=o.replace(/(\d)j(\d{3})/g,"$1,$2").replace(/(\d)J(\d{3})/g,"$1,$2");if(n.match(/^\s*¥(\d{1,2})\s*$/))return 0;let e="",r=n.includes("¥")||n.includes("円");for(const a of n){if(/\d/.test(a))e+=a;else if(a===","||a===".")continue;if(e.length>5)return 0}if(!e)return 0;e.length===4&&!r&&o.match(/^\s*1\d{3}\s*$/)&&o.match(/[¥円]/);const s=parseInt(e,10);return s>=100&&s<=3e4?s:0}function _(o){return new Promise((n,t)=>{const e=new FileReader;e.onloadend=()=>n(e.result),e.onerror=t,e.readAsDataURL(o)})}window.addEventListener("beforeunload",async()=>{m&&await m.terminate()});async function R(o,n){if(navigator.share&&navigator.canShare){const t={files:[o],title:n,text:"Save to Google Drive"};try{if(navigator.canShare(t))return await navigator.share(t),!0}catch(e){console.log("Share cancelled or failed:",e)}}return M(o,n),!1}function M(o,n){const t=URL.createObjectURL(o),e=document.createElement("a");e.href=t,e.download=n,e.style.display="none",document.body.appendChild(e),e.click(),setTimeout(()=>{document.body.removeChild(e),URL.revokeObjectURL(t)},100)}function g(o=null,n=null,t=null){let e;if(t)e=t;else{const s=new Date,a=s.getFullYear(),i=String(s.getMonth()+1).padStart(2,"0"),l=String(s.getDate()).padStart(2,"0");e=`${a}-${i}-${l}`}let r=e;return o&&(r+=`_${o}`),n&&(r+=`_${n}`),`${r}.jpg`}const x="drive-ocr-expense-items",q=[{id:"kaigi",label:"会議"},{id:"kousai",label:"交際"},{id:"koutuuhi",label:"交通費"},{id:"iryou",label:"医療"}];function k(){try{const o=localStorage.getItem(x);if(o)return JSON.parse(o)}catch(o){console.error("Failed to load expense items:",o)}return[...q]}function W(o){try{localStorage.setItem(x,JSON.stringify(o))}catch(n){console.error("Failed to save expense items:",n)}}function A(o){const n=k(),t=o.toLowerCase().replace(/[^a-z0-9]/g,"_");return n.some(e=>e.id===t)?!1:(n.push({id:t,label:o}),W(n),!0)}function B(o,n){const t=document.createElement("div");t.className="dialog-backdrop",t.innerHTML=`
    <div class="dialog">
      <h3 class="dialog-title">金額を選択してください</h3>
      <div class="dialog-options">
        ${o.map((a,i)=>`
          <button class="dialog-option" data-value="${a}">
            ¥${a.toLocaleString()}
          </button>
        `).join("")}
        <button class="dialog-option dialog-manual" data-value="manual">
          ✍️ 手動入力
        </button>
        <input type="number" class="dialog-amount-input" id="manual-amount-input" 
               placeholder="金額を入力" min="100" max="30000" 
               style="display: none;">
        <button class="dialog-option" data-value="none">
          上記以外
        </button>
        <button class="dialog-option dialog-retry" data-value="retry">
          📷 撮り直す
        </button>
      </div>
    </div>
  `;const e=t.querySelector("#manual-amount-input"),r=t.querySelector(".dialog-manual"),s=a=>{if(a.target.classList.contains("dialog-option")){const i=a.target.dataset.value;i==="manual"?(e.style.display="block",r.style.display="none",e.focus()):i==="retry"?(t.remove(),n("retry")):(t.remove(),n(i==="none"?null:i))}};e.addEventListener("keypress",a=>{if(a.key==="Enter"){const i=parseInt(e.value,10);i>=100&&i<=3e4?(t.remove(),n(String(i))):(e.style.borderColor="#f44336",setTimeout(()=>{e.style.borderColor="#4285f4"},1e3))}}),e.addEventListener("blur",a=>{setTimeout(()=>{t.contains(e)&&!e.value&&(e.style.display="none",r.style.display="block")},200)}),t.addEventListener("click",s),document.body.appendChild(t)}function L(o){const n=k(),t=document.createElement("div");t.className="dialog-backdrop",t.innerHTML=`
    <div class="dialog">
      <h3 class="dialog-title">項目を選択してください</h3>
      <div class="dialog-options">
        ${n.map(a=>`
          <button class="dialog-option" data-value="${a.id}">
            ${a.label}
          </button>
        `).join("")}
        <button class="dialog-option dialog-add" data-value="add">
          ➕ 項目を追加
        </button>
        <input type="text" class="dialog-item-input" id="new-item-input" 
               placeholder="新しい項目名" 
               style="display: none;">
      </div>
    </div>
  `;const e=t.querySelector("#new-item-input"),r=t.querySelector(".dialog-add"),s=a=>{if(a.target.classList.contains("dialog-option")){const i=a.target.dataset.value;i==="add"?(e.style.display="block",r.style.display="none",e.focus()):(t.remove(),o(i))}};e.addEventListener("keypress",a=>{if(a.key==="Enter"){const i=e.value.trim();i&&(A(i)?(t.remove(),L(o)):(e.style.borderColor="#f44336",setTimeout(()=>{e.style.borderColor="#4285f4"},1e3)))}}),e.addEventListener("blur",a=>{setTimeout(()=>{t.contains(e)&&!e.value&&(e.style.display="none",r.style.display="block")},200)}),t.addEventListener("click",s),document.body.appendChild(t)}function f(o,n){const t=new Date,e=new Date(t);e.setDate(e.getDate()-1);const r=d=>{const p=d.getFullYear(),w=String(d.getMonth()+1).padStart(2,"0"),T=String(d.getDate()).padStart(2,"0");return`${p}-${w}-${T}`},s=r(t),a=r(e),i=document.createElement("div");i.className="dialog-backdrop",i.innerHTML=`
    <div class="dialog">
      <h3 class="dialog-title">日付を選択してください</h3>
      <div class="dialog-options">
        <button class="dialog-option" data-value="${s}">
          今日 (${s})
        </button>
        <button class="dialog-option" data-value="${a}">
          昨日 (${a})
        </button>
        ${o.map(d=>`
          <button class="dialog-option" data-value="${d}">
            画像から読み取った日付 (${d})
          </button>
        `).join("")}
        <button class="dialog-option dialog-manual" data-value="manual">
          📅 手動で選ぶ
        </button>
        <input type="date" class="dialog-date-input" id="manual-date-input" value="${s}" style="display: none;">
        <button class="dialog-option" data-value="none">
          選択しない
        </button>
      </div>
    </div>
  `;const l=i.querySelector("#manual-date-input"),u=i.querySelector(".dialog-manual"),v=d=>{if(d.target.classList.contains("dialog-option")){const p=d.target.dataset.value;p==="manual"?(l.style.display="block",u.style.display="none",l.focus(),l.showPicker()):(i.remove(),n(p==="none"?null:p))}};l.addEventListener("change",d=>{const p=d.target.value;p&&(i.remove(),n(p))}),l.addEventListener("blur",d=>{setTimeout(()=>{i.contains(l)&&(l.style.display="none",u.style.display="block")},200)}),i.addEventListener("click",v),document.body.appendChild(i)}const c={video:document.getElementById("camera-video"),placeholder:document.getElementById("camera-placeholder"),captureBtn:document.getElementById("capture-btn"),uploadBtn:document.getElementById("upload-btn"),fileInput:document.getElementById("file-input"),progressContainer:document.getElementById("progress-container"),progressFill:document.getElementById("progress-fill"),progressText:document.getElementById("progress-text"),output:document.getElementById("output"),outputText:document.getElementById("output-text"),error:document.getElementById("error"),canvas:document.getElementById("capture-canvas")};let b=null;async function Y(){try{b=await S(c.video),c.placeholder.style.display="none",c.captureBtn.disabled=!1}catch(o){h("カメラへのアクセスが拒否されました。設定を確認してください。"),console.error("Camera init error:",o)}c.captureBtn.addEventListener("click",H),c.uploadBtn.addEventListener("click",()=>c.fileInput.click()),c.fileInput.addEventListener("change",z),document.addEventListener("visibilitychange",async()=>{if(document.visibilityState==="visible"&&b){const o=b.getVideoTracks();if(o.length===0||o[0].readyState!=="live")try{b=await S(c.video)}catch(n){console.error("Camera recovery failed:",n)}}})}async function H(){try{D(),c.captureBtn.disabled=!0;const o=await P(c.video,c.canvas);c.progressContainer.classList.add("active"),c.output.classList.remove("active");const n=await I(o,r=>{const s=Math.round(r*100);c.progressFill.style.width=`${s}%`,c.progressText.textContent=`${s}%`});if(c.progressContainer.classList.remove("active"),!n||n.trim().length===0){h("テキストを認識できませんでした。");return}c.output.classList.add("active"),c.outputText.textContent=n;const t=$(n),e=C(n);t.length===0?f(e,async r=>{const s=g(null,null,r),a=new File([o],s,{type:"image/jpeg"});await y(a)}):B(t,async r=>{if(r==="retry"){c.output.classList.remove("active");return}else r===null?f(e,async s=>{const a=g(null,null,s),i=new File([o],a,{type:"image/jpeg"});await y(i)}):f(e,async s=>{L(async a=>{const i=g(r,a,s),l=new File([o],i,{type:"image/jpeg"});await y(l)})})})}catch(o){h("処理中にエラーが発生しました: "+o.message),console.error("Capture error:",o)}finally{c.captureBtn.disabled=!1}}async function z(o){const n=o.target.files[0];if(n)try{D();const t=n;c.progressContainer.classList.add("active"),c.output.classList.remove("active");const e=await I(t,a=>{const i=Math.round(a*100);c.progressFill.style.width=`${i}%`,c.progressText.textContent=`${i}%`});if(c.progressContainer.classList.remove("active"),!e||e.trim().length===0){h("テキストを認識できませんでした。");return}c.output.classList.add("active"),c.outputText.textContent=e;const r=$(e),s=C(e);r.length===0?f(s,async a=>{const i=g(null,null,a),l=new File([t],i,{type:"image/jpeg"});await y(l)}):B(r,async a=>{if(a==="retry"){c.output.classList.remove("active"),c.fileInput.value="";return}else a===null?f(s,async i=>{const l=g(null,null,i),u=new File([t],l,{type:"image/jpeg"});await y(u)}):f(s,async i=>{L(async l=>{const u=g(a,l,i),v=new File([t],u,{type:"image/jpeg"});await y(v)})})})}catch(t){h("処理中にエラーが発生しました: "+t.message),console.error("Upload error:",t)}finally{c.fileInput.value=""}}async function y(o){await R(o,o.name)||h("共有に失敗しました。手動でダウンロードしてください。")}function h(o){c.error.textContent=o,c.error.classList.add("active")}function D(){c.error.classList.remove("active")}Y();
